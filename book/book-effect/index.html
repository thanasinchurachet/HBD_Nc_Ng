<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <link rel="stylesheet" href="style.css" />
  <title>Flipbook — Responsive (turn.js)</title>
</head>
<body>
  <script>
    try { const nav = performance.getEntriesByType && performance.getEntriesByType('navigation')[0]; if(nav && nav.type === 'reload'){ window.location.replace('../../HBD_9.html'); } } catch(e){}
  </script>
  <div class="flipbook" id="flipbook">
    <!-- Front cover (hard) uses 1.png -->
    <div class="hard cover"><img src="../../pages/1.png" alt="Cover" /></div>
    <div class="hard inner-cover"></div>

    <!-- Pages 2..9 -->
    <div class="page"><img src="../../pages/2.png" alt="Page 2" /></div>
    <div class="page"><img src="../../pages/3.png" alt="Page 3" /></div>
    <div class="page"><img src="../../pages/4.png" alt="Page 4" /></div>
    <div class="page"><img src="../../pages/5.png" alt="Page 5" /></div>
    <div class="page"><img src="../../pages/6.png" alt="Page 6" /></div>
    <div class="page"><img src="../../pages/7.png" alt="Page 7" /></div>
    <div class="page"><img src="../../pages/8.png" alt="Page 8" /></div>
    <div class="page"><img src="../../pages/9.png" alt="Page 9" /></div>

    <!-- Back cover (hard) uses 10.png -->
    <div class="hard inner-back"></div>
    <div class="hard back"><img src="../../pages/10.png" alt="Back cover" /></div>
  </div>

  <!-- Turntable overlay was removed as requested -->

  <!-- Mini audio player (plays while reading) -->
  <div class="audio-player" id="audioPlayer" aria-label="Music player">
    <img id="ap_cover" alt="cover" />
    <div class="ap-info">
      <div class="ap-title" id="ap_title">—</div>
      <div class="ap-bar">
        <button id="ap_prev"  class="icon" aria-label="ก่อนหน้า" title="ก่อนหน้า">
          <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M7 12L18 5v14L7 12zm-1 7H4V5h2v14z"/></svg>
        </button>
        <button id="ap_toggle" class="icon" data-state="play" aria-label="เล่น/พัก" title="เล่น/พัก">
          <svg class="ic-play" viewBox="0 0 24 24" aria-hidden="true"><path d="M8 5v14l11-7z"/></svg>
          <svg class="ic-pause" viewBox="0 0 24 24" aria-hidden="true"><path d="M6 5h4v14H6zm8 0h4v14h-4z"/></svg>
        </button>
        <button id="ap_next"  class="icon" aria-label="ถัดไป" title="ถัดไป">
          <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M6 19V5l11 7-11 7zm12 0h2V5h-2v14z"/></svg>
        </button>
        <input id="ap_seek" type="range" min="0" max="100" value="0" step="0.1" aria-label="เลื่อนเวลา" />
        <span id="ap_time">0:00</span>
        <button id="ap_hide"  class="icon" aria-label="ซ่อนแถบ" title="ซ่อนแถบ">
          <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M7 10l5 5 5-5H7z"/></svg>
        </button>
      </div>
    </div>
  </div>
  <button class="audio-fab" id="ap_fab" aria-label="แสดงแถบเพลง" title="แสดงแถบเพลง">
    <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M7 14l5-5 5 5H7z"/></svg>
  </button>
  <audio id="bgm" preload="metadata"></audio>

  <script src="jquery.js"></script>
  <script src="turn.js"></script>
  <script>
    (function(){
      const $flip = $("#flipbook");

      // Init once with sane defaults
      $flip.turn({
        display: 'double',
        autoCenter: true,
        gradients: true,
        acceleration: true,
        elevation: 30,
        duration: 700
      });

      // Correct ratio from actual page size 540x760 (W x H)
      const PAGE_RATIO = 760 / 540; // height / width per single page
      const DOUBLE_RATIO = PAGE_RATIO / 2; // height / width for the whole book (two pages)
      const MIN_PAGE_W = 380;       // do not scale below this width per page

      function computeSize(){
        const vw = window.innerWidth;
        const vh = window.innerHeight;
        // Always show two pages by scaling whole book to fit
        const PAGE_MIN_W = 160; // min width per page to allow very small screens
        const maxBookW = vw * 0.98;     // available width for whole book
        const maxBookH = vh * 0.92;     // available height for whole book

        // Option A: bound by width; resulting height must fit
        let bookW = maxBookW;
        let bookH = bookW * DOUBLE_RATIO;
        if (bookH > maxBookH) {
          // Option B: bound by height
          bookH = maxBookH;
          bookW = bookH / DOUBLE_RATIO;
        }

        // Clamp per-page width, then recompute consistent book dimensions
        const perPageW = Math.max(PAGE_MIN_W, Math.floor(bookW / 2));
        bookW = perPageW * 2;
        bookH = Math.floor(perPageW * PAGE_RATIO);

        $flip.turn('display','double');
        $flip.turn('size', Math.round(bookW), Math.round(bookH));
      }

      // Debounced resize for smoother responsiveness
      const onResize = (() => {
        let t = null; 
        return () => { clearTimeout(t); t = setTimeout(computeSize, 120); };
      })();

      computeSize();
      window.addEventListener('resize', onResize);
      window.addEventListener('orientationchange', () => setTimeout(computeSize, 150));

      // Tap zones + custom drag-from-anywhere helper (does not conflict with turn.js corner drag)
      let downPos = null, dragFlipped = false;
      $flip[0].addEventListener('pointerdown', function(e){
        // ignore controls
        if (e.target.closest && e.target.closest('.audio-player, .audio-fab')) return;
        downPos = { x: e.clientX, y: e.clientY };
        dragFlipped = false;
      }, { passive:true });
      $flip[0].addEventListener('pointermove', function(e){
        if (!downPos || dragFlipped) return;
        const dx = e.clientX - downPos.x;
        const dy = e.clientY - downPos.y;
        if (Math.abs(dx) > 40 && Math.abs(dy) < 80) {
          // Trigger one flip and let go; turn.js will animate
          if (dx < 0) $flip.turn('next'); else $flip.turn('previous');
          dragFlipped = true; // prevent multiple
        }
      }, { passive:true });
      $flip[0].addEventListener('pointerup', function(e){
        if (!downPos) return; // not a valid down
        const dx = Math.abs(e.clientX - downPos.x);
        const dy = Math.abs(e.clientY - downPos.y);
        downPos = null;
        // If pointer moved only a little, treat as tap; otherwise it was a drag
        if (dx + dy > 10 || dragFlipped) return;
        const rect = $flip[0].getBoundingClientRect();
        const x = e.clientX, y = e.clientY;
        if (x < rect.left || x > rect.right || y < rect.top || y > rect.bottom) return;
        const leftZone = rect.left + rect.width*0.25;
        const rightZone = rect.left + rect.width*0.75;
        if (x <= leftZone) $flip.turn('previous');
        if (x >= rightZone) $flip.turn('next');
      }, { passive:true });

      // ===== Simple audio player =====
      const audio = document.getElementById('bgm');
      const toggle = document.getElementById('ap_toggle');
      const seek = document.getElementById('ap_seek');
      const timeEl = document.getElementById('ap_time');
      const prevBtn = document.getElementById('ap_prev');
      const nextBtn = document.getElementById('ap_next');
      const hideBtn = document.getElementById('ap_hide');
      const fabBtn  = document.getElementById('ap_fab');
      const player  = document.getElementById('audioPlayer');
      const apTitle = document.getElementById('ap_title');
      const apCover = document.getElementById('ap_cover');

      // Playlist (add more here). Removed hbd.mp3 as requested.
      const PLAYLIST = [
      '../../music/ดวงใจ - PALMY「Official Lyric Video」.mp3',
        '../../music/ทะเลสีดำ - Lula,ต้า Paradox【OFFICIAL MV】.mp3',
        '../../music/ยังไงก็รัก-ไก่ สมพล ปิยะพงศ์สิริ.mp3',
        '../../music/เพลงรัก - Three Man Down _Official MV_.mp3',
        '../../music/คู่ชีวิต - COCKTAIL「Official MV (Cut Version)」.mp3',
        '../../music/LANDOKMAI - เพลงรักเพลงแรก (Blooming) [Official MV].mp3',
        '../../music/ซูลูปาก้า ตาปาเฮ้ - themoonwillalwaysbewithme  official audio .mp3'
      ];
      let index = 0;
      const toTitle = (path) => decodeURIComponent(path.split('/').pop()).replace(/\.[a-z0-9]+$/i,'');
      function load(i){
        index = (i+PLAYLIST.length)%PLAYLIST.length;
        audio.src = PLAYLIST[index];
        apTitle.textContent = toTitle(PLAYLIST[index]);
        // Set default cover (you can change this file)
        apCover.src = '../../music/poster.gif';
        apCover.style.display = 'block';
        audio.load();
      }
      load(0);
      audio.volume = 0.4;
      const fmt = (s)=>{ s=Math.max(0, s|0); const m=(s/60)|0; const ss=('0'+(s%60)).slice(-2); return m+':'+ss; };
      function update(){ if(!isNaN(audio.duration)){ seek.max = audio.duration; } seek.value = audio.currentTime||0; timeEl.textContent = fmt(audio.currentTime||0); }
      function setPlayingUI(on){ if(on){ player.classList.add('playing'); toggle.setAttribute('data-state','pause'); } else { player.classList.remove('playing'); toggle.setAttribute('data-state','play'); } }
      toggle.addEventListener('click', ()=>{ if(audio.paused){ audio.play(); setPlayingUI(true); } else { audio.pause(); setPlayingUI(false); } });
      prevBtn.addEventListener('click', ()=>{ if(PLAYLIST.length>1){ load(index-1); audio.play(); toggle.textContent='❚❚'; }});
      nextBtn.addEventListener('click', ()=>{ if(PLAYLIST.length>1){ load(index+1); audio.play(); toggle.textContent='❚❚'; }});
      seek.addEventListener('input', ()=>{ try{ audio.currentTime = +seek.value; }catch(e){} });
      audio.addEventListener('timeupdate', update);
      audio.addEventListener('loadedmetadata', update);
      audio.addEventListener('ended', ()=>{ if(PLAYLIST.length>1){ load(index+1); audio.play(); } else { setPlayingUI(false); } });

      // Hide / show player
      hideBtn.addEventListener('click', (ev)=>{ ev.stopPropagation(); player.classList.add('collapsed'); fabBtn.classList.add('show'); });
      fabBtn.addEventListener('click', (ev)=>{ ev.stopPropagation(); player.classList.remove('collapsed'); fabBtn.classList.remove('show'); });
      // Prevent player clicks from triggering page turn
      player.addEventListener('click', (ev)=> ev.stopPropagation());

      // Turntable overlay flow
      // Autoplay after leaving envelope page (if flag is set)
      try {
        if (sessionStorage.getItem('autoplay') === '1') {
          sessionStorage.removeItem('autoplay');
          let attempts = 0;
          const tryPlay = () => {
            audio.play().then(()=>{ setPlayingUI(true); })
            .catch(()=>{ if(attempts++ < 6) setTimeout(tryPlay, 350); });
          };
          const passed = sessionStorage.getItem('autoplaySong');
          if(passed){
            const idx = PLAYLIST.findIndex(p=> p.endsWith(passed.replace('../','')) || p.endsWith(passed));
            if(idx>=0){ load(idx); }
            sessionStorage.removeItem('autoplaySong');
          }
          tryPlay();
        }
      } catch(e) {}
      // Fallback: first interaction starts audio if paused
      window.addEventListener('pointerdown', ()=>{
        if (audio.paused) {
          audio.play().then(()=>{ toggle.textContent='❚❚'; player.classList.add('playing'); }).catch(()=>{});
        }
      }, { once:true });
    })();
  </script>
</body>
</html>
